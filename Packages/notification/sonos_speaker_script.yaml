script:
  sonos_audio_notificatie_v50:
    alias: Sonos - Audio Notificatie v5
    sequence:
      #If the Apple TV (or other TV device) is using the Sonos for audio output, you want the Apple TV                  
      #(or other tv device) to pause before Sonos will broadcast the notification, but only if the message has PRIORITY
      #THIS PART IS ONLY REQUIRED IF YOU HAVE A SONOS SOUNDBAR AND YOU USE IT FOR TV/XBOX/MEDIAPLAYER AUDIO
      - if:
          - condition: and
            conditions:
              - condition: state
                entity_id: media_player.woonkamer_appletv
                state: playing
                enabled: true
              - condition: state
                entity_id: media_player.woonkamer_sonos
                state: playing
              - condition: state
                entity_id: media_player.woonkamer_sonos
                attribute: source
                state: TV
              - condition: template
                value_template: "{{ (media_player_entity == 'media_player.woonkamer_sonos') }}"
              - condition: template
                value_template: "{{ message_tts_priority == true }}"
                enabled: true
        then:
          #If the TV is playing, pause ATV and continue with the script (and turn on boolean, 
          #required for resume action at the end of the script).
          - service: media_player.media_pause
            data: {}
            enabled: true
            target:
              entity_id: media_player.woonkamer_appletv
          - service: input_boolean.turn_on
            data: {}
            target:
              entity_id: input_boolean.sonos_audio_notificatie_apple_tv_playing
        enabled: true
      - if:
        #If the message has NO PRIORITY it will show a push notification on the TV instead.
        #THIS PART IS ONLY REQUIRED IF YOU HAVE A SONOS SOUNDBAR AND YOU USE IT FOR TV/XBOX/MEDIAPLAYER AUDIO        
          - condition: and
            conditions:
              - condition: state
                entity_id: media_player.woonkamer_appletv
                state: playing
                enabled: false
              - condition: state
                entity_id: media_player.woonkamer_sonos
                state: playing
              - condition: state
                entity_id: media_player.woonkamer_sonos
                attribute: source
                state: TV
              - condition: template
                value_template: "{{ (media_player_entity == 'media_player.woonkamer_sonos') }}"
              - condition: template
                value_template: "{{ message_tts_priority != true }}"
        then:
          - service: script.notificatie_lg_tv_1
            data:
              notify_tv: "{{notify_tv}}"
              message_tv_body: "{{message_tv_body}}"
          - service: script.turn_off
            data: {}
            target:
              entity_id: script.sonos_audio_notificatie_v5
        enabled: true
      - if:
        #If the Xbox is turned on, then always show a push notification on the TV. This could probably be merged with the previous action. 
        #THIS PART IS ONLY REQUIRED IF YOU HAVE A SONOS SOUNDBAR AND YOU USE IT FOR TV/XBOX/MEDIAPLAYER AUDIO        
          - condition: and
            conditions:
              - condition: state
                entity_id: media_player.woonkamer_tv
                state: XBOX
                enabled: true
                attribute: source
              - condition: state
                entity_id: media_player.woonkamer_sonos
                state: playing
              - condition: state
                entity_id: media_player.woonkamer_sonos
                attribute: source
                state: TV
              - condition: template
                value_template: "{{ (media_player_entity == 'media_player.woonkamer_sonos') }}"
        then:
          - service: script.notificatie_lg_tv_1
            data:
              notify_tv: "{{notify_tv}}"
              message_tv_body: "{{message_tv_body}}"
          - service: script.turn_off
            data: {}
            target:
              entity_id: script.sonos_audio_notificatie_v5
        enabled: true
        #If the Apple TV Boolean (from one of the previous steps) was turned on, resume playing on the Apple TV.
        #THIS PART IS ONLY REQUIRED IF YOU HAVE A SONOS SOUNDBAR AND YOU USE IT FOR TV/XBOX/MEDIAPLAYER AUDIO        
      - if:
          - condition: state
            entity_id: input_boolean.sonos_audio_notificatie_apple_tv_playing
            state: "on"
        then:
          - service: media_player.media_play_pause
            data: {}
            target:
              entity_id: media_player.woonkamer_appletv
          - service: input_boolean.turn_off
            data: {}
            target:
              entity_id: input_boolean.sonos_audio_notificatie_apple_tv_playing
      - if:
        #Check if Voice Response is turned on for the specific speaker, this is done based on time of day or activity in a specific room
        #If it is turned on, play the TTS, other wise don't play it.
          - condition: template
            value_template: "{{ (states(\"input_boolean.voice_response_\" ~ ruimte) == 'on') }}"
        then:
        #I've used Microsoft TTS, but you can use any TTS here.
          - service: tts.microsoft_say
            data:
              cache: false
              entity_id: "{{media_player_entity}}"
              message: "{{message_tts_body}}"
    icon: mdi:speaker-message
    mode: parallel
    max: 10
